<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cozy Alarm</title>
    <!-- Tailwind CSS CDN for a professional and modern look -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            /* Ensure the body is a flex container to center the card */
            @apply flex items-center justify-center min-h-screen p-4;
            @apply dark:bg-slate-900 dark:text-slate-100 bg-amber-100 text-amber-900;
        }
        .alarm-card {
            /* The card itself is a flex container with aligned content */
            @apply flex flex-col items-center dark:bg-slate-800 dark:bg-opacity-70 dark:backdrop-blur-md bg-white bg-opacity-70 backdrop-blur-md p-8 rounded-2xl shadow-2xl w-full max-w-lg;
            border: 1px solid;
            @apply dark:border-slate-700 border-gray-300;
        }
        .modal-backdrop {
            @apply fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden;
        }
        .modal-content {
            @apply dark:bg-slate-800 dark:bg-opacity-70 bg-white bg-opacity-70 p-8 rounded-2xl shadow-2xl w-full max-w-md text-center;
            border: 1px solid;
            @apply dark:border-slate-700 border-gray-300;
        }
        .theme-toggle-button {
            @apply p-2 rounded-full transition-colors duration-300;
            @apply dark:bg-slate-700 dark:hover:bg-slate-600 bg-gray-200 hover:bg-gray-300;
        }
    </style>
</head>
<body>

    <!-- Main Alarm Card -->
    <div id="main-alarm-card" class="alarm-card">
        <div class="flex justify-between items-center w-full mb-6">
            <h1 class="text-3xl font-bold text-emerald-600 dark:text-emerald-400">Cozy Alarm</h1>
            <button id="themeToggleBtn" class="theme-toggle-button">
                <svg id="moonIcon" class="w-6 h-6 text-yellow-400 dark:text-slate-400 hidden dark:block" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                </svg>
                <svg id="sunIcon" class="w-6 h-6 text-yellow-500 dark:text-slate-100 block dark:hidden" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4.586 1.586a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM4 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM7.05 4.95a1 1 0 011.414 0L10 6.414a1 1 0 01-1.414 1.414L7.05 6.364a1 1 0 010-1.414zM12.95 4.95a1 1 0 010 1.414L11.586 7.828a1 1 0 01-1.414-1.414l1.364-1.364a1 1 0 011.414 0zM10 16a1 1 0 01-1 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.586 14.586a1 1 0 01-1.414 0L2.707 12.707a1 1 0 011.414-1.414l1.414 1.414a1 1 0 010 1.414zM12.707 16.293a1 1 0 01-1.414 0l-1.414-1.414a1 1 0 011.414-1.414l1.414 1.414a1 1 0 010 1.414zM16 10a6 6 0 11-12 0 6 6 0 0112 0z"></path>
                </svg>
            </button>
        </div>
        
        <p class="mb-6 font-bold text-slate-600 dark:text-slate-400 text-center">
            Set a time or a countdown. When the alarm rings, you must solve three math problems to stop it.
        </p>
        
        <div class="space-y-4 w-full">
            <!-- Time Input -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4">
                <label for="timeInput" class="font-bold text-amber-900 dark:text-slate-300 flex-none">Set specific time:</label>
                <input type="time" id="timeInput" class="flex-grow p-2 rounded-lg bg-amber-200 dark:bg-slate-700 border border-amber-300 dark:border-slate-600 focus:outline-none focus:border-emerald-500 dark:focus:border-emerald-400 transition-colors">
            </div>

            <!-- Countdown Input -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4">
                <label for="countdownInput" class="font-bold text-amber-900 dark:text-slate-300 flex-none">Set countdown (minutes):</label>
                <input type="number" id="countdownInput" min="1" step="1" placeholder="e.g. 5" class="flex-grow p-2 rounded-lg bg-amber-200 dark:bg-slate-700 border border-amber-300 dark:border-slate-600 focus:outline-none focus:border-emerald-500 dark:focus:border-emerald-400 transition-colors">
            </div>

            <!-- Control Buttons -->
            <div class="flex space-x-4 pt-2 w-full">
                <button id="setAlarmBtn" class="flex-grow bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Set Alarm</button>
                <button id="clearAlarmBtn" class="flex-grow bg-transparent text-emerald-600 dark:text-emerald-400 border border-emerald-600 dark:border-emerald-400 hover:bg-emerald-600 hover:text-white dark:hover:bg-emerald-400 dark:hover:text-white font-semibold py-2 px-4 rounded-lg transition-colors hidden">Clear Alarm</button>
            </div>
        </div>

        <!-- Status Message -->
        <p id="statusMessage" class="mt-6 text-sm text-center font-bold text-slate-600 dark:text-slate-400 w-full">No alarm set.</p>
    </div>

    <!-- Puzzle Modal (Hidden by default) -->
    <div id="puzzleModal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-red-600 dark:text-red-400 mb-2">ALARM! Solve to Stop</h2>
            <p class="text-slate-600 dark:text-slate-400 text-sm mb-6 font-bold">Answer all questions correctly to disable the alarm. Keep this tab open!</p>
            
            <div id="puzzleContainer" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                <!-- Puzzle inputs will be dynamically inserted here by JavaScript -->
            </div>
            
            <button id="stopAlarmBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Stop Alarm
            </button>
        </div>
    </div>

    <script>
        // Use a self-invoking anonymous function to keep variables out of the global scope
        (function() {
            // --- DOM Elements ---
            const timeInput = document.getElementById('timeInput');
            const countdownInput = document.getElementById('countdownInput');
            const setAlarmBtn = document.getElementById('setAlarmBtn');
            const clearAlarmBtn = document.getElementById('clearAlarmBtn');
            const statusMessage = document.getElementById('statusMessage');
            const puzzleModal = document.getElementById('puzzleModal');
            const puzzleContainer = document.getElementById('puzzleContainer');
            const stopAlarmBtn = document.getElementById('stopAlarmBtn');
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            const htmlTag = document.documentElement;
            
            // --- State Variables ---
            let alarmTime = null; // Stores the timestamp of the alarm
            let alarmIntervalId = null; // ID for the setInterval timer
            let puzzleAnswers = []; // Stores the correct answers for the puzzles
            let audioContext = null;
            let oscillator = null;

            // --- Utility Functions ---

            // Toggles between dark and light themes
            function toggleTheme() {
                if (htmlTag.classList.contains('dark')) {
                    htmlTag.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                } else {
                    htmlTag.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                }
            }
            
            // Loads the theme from local storage on page load
            function loadTheme() {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme) {
                    if (savedTheme === 'dark') {
                        htmlTag.classList.add('dark');
                    } else {
                        htmlTag.classList.remove('dark');
                    }
                }
            }

            // Formats milliseconds into a human-readable string (e.g., "1h 30m 5s")
            function formatTimeRemaining(ms) {
                if (ms <= 0) return '0s';
                const totalSeconds = Math.floor(ms / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                let parts = [];
                if (hours > 0) parts.push(`${hours}h`);
                if (minutes > 0) parts.push(`${minutes}m`);
                if (seconds > 0) parts.push(`${seconds}s`);
                
                return parts.join(' ');
            }

            // Starts the alarm sound using the Web Audio API
            function startAlarmTone() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                if (oscillator) return; // Prevent multiple tones
                
                // Create a gain node to control volume and add a tremolo effect
                const gainNode = audioContext.createGain();
                
                // Create the main oscillator (the alarm sound itself)
                oscillator = audioContext.createOscillator();
                oscillator.type = 'sawtooth'; // A harsh, loud tone
                oscillator.frequency.value = 440; // Base frequency (A4)
                
                // Create a Low-Frequency Oscillator for the tremolo effect
                const lfo = audioContext.createOscillator();
                lfo.type = 'sine';
                lfo.frequency.value = 5; // 5Hz for a noticeable pulsing
                
                const lfoGain = audioContext.createGain();
                lfoGain.gain.value = 0.5; // Controls the intensity of the tremolo
                
                // Connect the LFO to the gain node
                lfo.connect(lfoGain);
                lfoGain.connect(gainNode.gain);
                
                // Connect the main oscillator to the gain node, then to the speakers
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start();
                lfo.start();
                
                // Save the nodes to stop them later
                oscillator._lfo = lfo;
                oscillator._gain = gainNode;
            }

            // Stops the alarm sound
            function stopAlarmTone() {
                if (oscillator) {
                    try {
                        oscillator.stop();
                        oscillator._lfo.stop();
                        oscillator.disconnect();
                        oscillator = null;
                    } catch (e) {
                        console.error("Failed to stop oscillator:", e);
                    }
                }
            }

            // Displays the puzzle modal and generates the puzzles
            function showPuzzleModal() {
                puzzleContainer.innerHTML = '';
                puzzleAnswers = [];

                for (let i = 0; i < 3; i++) {
                    const ops = ['+', '-', '*'];
                    const op = ops[Math.floor(Math.random() * ops.length)];
                    let a = Math.floor(Math.random() * 12) + 1;
                    let b = Math.floor(Math.random() * 12) + 1;

                    // Ensure subtraction results are not negative
                    if (op === '-' && a < b) [a, b] = [b, a];
                    
                    const expression = `${a} ${op} ${b}`;
                    let answer = 0;
                    switch(op) {
                        case '+': answer = a + b; break;
                        case '-': answer = a - b; break;
                        case '*': answer = a * b; break;
                    }
                    puzzleAnswers.push(String(answer));
                    
                    const puzzleDiv = document.createElement('div');
                    puzzleDiv.className = "flex flex-col items-center p-4 rounded-lg";
                    puzzleDiv.classList.add('bg-white', 'dark:bg-slate-700'); // Dynamic theme classes
                    puzzleDiv.innerHTML = `
                        <span class="text-xl font-bold dark:text-slate-100 text-amber-900 mb-2">${expression} = ?</span>
                        <input type="number" class="w-full p-2 rounded-md dark:bg-slate-600 dark:text-slate-100 bg-amber-200 text-amber-900 border dark:border-slate-500 border-amber-300 focus:outline-none focus:ring-2 focus:ring-emerald-400" placeholder="Answer" />
                    `;
                    puzzleContainer.appendChild(puzzleDiv);
                }
                
                puzzleModal.style.display = 'flex';
                stopAlarmBtn.disabled = true; // Button is disabled until puzzles are solved
            }

            // Hides the puzzle modal
            function hidePuzzleModal() {
                puzzleModal.style.display = 'none';
            }

            // Checks if all puzzles have been solved correctly
            function checkPuzzles() {
                const inputs = Array.from(puzzleContainer.querySelectorAll('input'));
                let allCorrect = true;
                
                inputs.forEach((input, index) => {
                    if (input.value.trim() !== puzzleAnswers[index]) {
                        allCorrect = false;
                    }
                });

                stopAlarmBtn.disabled = !allCorrect;
            }

            // Main alarm trigger function
            function triggerAlarm() {
                clearInterval(alarmIntervalId);
                alarmIntervalId = null;
                statusMessage.textContent = 'ALARM IS RINGING!';
                startAlarmTone();
                showPuzzleModal();
                // We'll hide the Clear Alarm button once the alarm starts ringing
                clearAlarmBtn.classList.add('hidden');
            }

            // --- Event Listeners ---
            document.addEventListener('DOMContentLoaded', loadTheme);
            themeToggleBtn.addEventListener('click', toggleTheme);

            // Set Alarm Button
            setAlarmBtn.addEventListener('click', () => {
                // To allow Web Audio to play, we need to interact with the AudioContext
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                // Clear any existing alarm first
                if (alarmIntervalId) {
                    clearInterval(alarmIntervalId);
                }

                const timeValue = timeInput.value;
                const countdownValue = parseInt(countdownInput.value, 10);

                if (timeValue) {
                    const [hours, minutes] = timeValue.split(':');
                    const now = new Date();
                    const alarmDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
                    
                    // If the time is in the past today, set it for tomorrow
                    if (alarmDate.getTime() < now.getTime()) {
                        alarmDate.setDate(alarmDate.getDate() + 1);
                    }
                    alarmTime = alarmDate.getTime();
                } else if (!isNaN(countdownValue) && countdownValue > 0) {
                    alarmTime = Date.now() + countdownValue * 60 * 1000;
                } else {
                    // Custom modal for alert, as per instructions
                    const customAlert = document.createElement('div');
                    customAlert.innerHTML = `
                        <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                            <div class="p-6 rounded-lg text-center shadow-lg dark:bg-slate-800 bg-white">
                                <p class="dark:text-slate-100 text-amber-900 font-bold">Please set a valid time or countdown.</p>
                                <button class="mt-4 bg-emerald-600 text-white px-4 py-2 rounded-lg" onclick="this.parentElement.parentElement.remove()">OK</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(customAlert);
                    return;
                }
                
                // Hide the clear button when a new alarm is set
                clearAlarmBtn.classList.add('hidden');
                
                statusMessage.textContent = `Alarm set. Rings in ${formatTimeRemaining(alarmTime - Date.now())}.`;
                
                // Start a timer that checks every second
                alarmIntervalId = setInterval(() => {
                    const now = Date.now();
                    const timeRemaining = alarmTime - now;
                    statusMessage.textContent = `Alarm set. Rings in ${formatTimeRemaining(timeRemaining)}.`;
                    
                    if (timeRemaining <= 0) {
                        triggerAlarm();
                    }
                }, 1000);
            });

            // Clear Alarm Button
            clearAlarmBtn.addEventListener('click', () => {
                if (alarmIntervalId) {
                    clearInterval(alarmIntervalId);
                    alarmIntervalId = null;
                }
                stopAlarmTone();
                hidePuzzleModal();
                alarmTime = null;
                statusMessage.textContent = 'Alarm cleared.';
                clearAlarmBtn.classList.add('hidden');
            });

            // Stop Alarm Button
            stopAlarmBtn.addEventListener('click', () => {
                // This button is only enabled if the puzzles are solved
                stopAlarmTone();
                hidePuzzleModal();
                alarmTime = null;
                statusMessage.textContent = 'Alarm stopped. Puzzle solved!';
                
                // Show the "Clear Alarm" button once the puzzle is solved
                clearAlarmBtn.classList.remove('hidden');
            });

            // Event listener for puzzle inputs
            puzzleContainer.addEventListener('input', checkPuzzles);
        })();
    </script>
</body>
</html>
